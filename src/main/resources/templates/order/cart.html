<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>Корзина</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .quantity-input {
            width: 70px;
            text-align: center;
        }
    </style>
</head>
<body>
<div th:insert="~{menunavy::futher-nav(isEmployee=${true})}"></div>
<div class="container mt-4">
    <h1 class="mb-4"><i class="bi bi-cart3"></i> <span th:text="#{general.title.cart}" ></span> </h1>

<!--    If the cart is empty-->
    <div id="cart-empty" class="alert alert-info" style="display: none;">
        <i class="bi bi-cart-x"></i> <span th:text="#{banner.cart-is-empty}" ></span>
    </div>

<!--    There is at least one order row in cart-->
    <div id="cart-content" style="display: none;">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th th:text="#{cart.appliance.title}"></th>
                    <th th:text="#{cart.appliance.price}"></th>
                    <th th:text="#{cart.appliance.quantity}"></th>
                    <th th:text="#{cart.appliance.sum}"></th>
                    <th></th>
                </tr>
                </thead>
                <tbody id="cart-items">
<!--                Order rows render via JS-->
                </tbody>
                <tfoot>
                <tr>
                    <td colspan="3" class="text-end fw-bold" th:text="#{cart.appliance.total}"></td>
                    <td id="cart-total" class="fw-bold">0</td>
                    <td></td>
                </tr>
                </tfoot>
            </table>
        </div>

        <div class="d-flex justify-content-end mt-3">
            <button id="confirm-order" class="btn btn-success">
                <i class="bi bi-check-circle"></i>
                <span th:text="#{cart.appliance.confirm}"></span>
            </button>

        </div>
    </div>
</div>

<script th:inline="javascript">
    let cart = JSON.parse(localStorage.getItem('cart')) || {items: []};

    // message.properties
    let currency = [[#{currency}]];
    let error_title = [[#{cart.order.error}]];

    function renderCart() {
        const cartItemsContainer = document.getElementById('cart-items');
        const cartEmpty = document.getElementById('cart-empty');
        const cartContent = document.getElementById('cart-content');
        const cartTotal = document.getElementById('cart-total');
        const placeForButton = document.getElementById('confirm-order');

        if (cart.items.length === 0) {
            cartEmpty.style.display = 'block';
            cartContent.style.display = 'none';
            placeForButton.disable()
            return;
        }

        cartEmpty.style.display = 'none';
        cartContent.style.display = 'block';
        cartItemsContainer.innerHTML = '';

        let total = 0;

        cart.items.forEach((item, index) => {
            const sum = (item.price * item.quantity);
            total += sum;
            const row = document.createElement('tr');
            row.innerHTML = `
                    <td>${item.productName}</td>
                    <td>${item.price} ${currency}}.</td>
                    <td>
                        <div class="input-group input-group-sm" style="width: 120px;">
                            <button class="btn btn-outline-secondary minus-btn" data-index="${index}">
                                <i class="bi bi-dash"></i>
                            </button>
                            <input type="number" class="form-control quantity-input"
                                   value="${item.quantity}" min="1" data-index="${index}">
                            <button class="btn btn-outline-secondary plus-btn" data-index="${index}">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </td>
                    <td>${sum.toFixed(2)} ${currency}.</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger remove-btn" data-index="${index}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
            cartItemsContainer.appendChild(row);
        });

        cartTotal.textContent = `${total.toFixed(2)} ${currency}.`;
    }

    document.addEventListener('click', (e) => {
        if (e.target.closest('.minus-btn')) {
            const index = e.target.closest('.minus-btn').dataset.index;
            if (cart.items[index].quantity > 1) {
                cart.items[index].quantity--;
                localStorage.setItem('cart', JSON.stringify(cart));
                renderCart();
            }
        }

        if (e.target.closest('.plus-btn')) {
            const index = e.target.closest('.plus-btn').dataset.index;
            cart.items[index].quantity++;
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
        }

        if (e.target.closest('.remove-btn')) {
            const index = e.target.closest('.remove-btn').dataset.index;
            cart.items.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
        }
    });

    document.addEventListener('change', (e) => {
        if (e.target.classList.contains('quantity-input')) {
            const index = e.target.dataset.index;
            const newQuantity = parseInt(e.target.value);

            if (newQuantity >= 1) {
                cart.items[index].quantity = newQuantity;
                localStorage.setItem('cart', JSON.stringify(cart));
                renderCart();
            } else {
                e.target.value = cart.items[index].quantity;
            }
        }
    });

    document.getElementById('confirm-order').addEventListener('click', async () => {
        if (cart.items.length === 0) {
            alert('Корзина пуста!');
            return;
        }

        const calculatedOnFrontTotal = parseFloat(
            cart.items.reduce((sum, item) => {
                return sum + item.quantity * item.price;
            }, 0).toFixed(2)
        );

        const orderData = {
            orderRowSet: cart.items.map(item => ({
                applianceId: item.productId,
                number: item.quantity
            })),
            calculatedOnFrontTotal
        };

        try {
            const response = await fetch('/cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            });

            if (response.ok) {
                localStorage.setItem("success-time-stamp", Date.now());
                localStorage.removeItem('cart');
                window.location.href = '/appliances?success=true';
            } else {
                alert(`${error_title}`);
            }
        } catch (error) {
            alert(`${error_title}`);
        }
    });

    renderCart();
</script>
</body>
</html>